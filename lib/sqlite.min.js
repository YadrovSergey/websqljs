!function(e,t){"function"==typeof define&&define.amd?define(["lodash"],t):"object"==typeof exports?module.exports=t(require("lodash")):e.sqlitejs=t(e.lodash)}(this,function(e){var t=function(e){e.sqlitePlugin?this._db=window.sqlitePlugin.openDatabase(e.name,e.version,e.displayname,e.size):this._db=openDatabase(e.name,e.version,e.displayname,e.size),this.debug=e.debug||!1};t.prototype={_cache:{},_toWebSQLValue:function(e){return(_.isObject(e)||_.isArray(e))&&(e=e instanceof Date?e.getTime():JSON.stringify(e)),_.isString(e)&&(e="'"+e+"'"),e},_fromWebSqlToJsValue:function(e,t){var n=[];if(t&&t.rows&&0!==t.rows.length){for(var i=0;i<t.rows.length;i++){var r=t.rows.item(i),a={};for(var u in r)if(r.hasOwnProperty(u)){a[u]=r[u];var o=this._cache[e+"_"+u];"json"===o?a[u]=JSON.parse(r[u]):"date"===o||"created_at"===u||"updated_at"===u?a[u]=new Date(r[u]):(null===a[u]||void 0===a[u])&&("text"===o?a[u]="":("numeric"===o||"integer"===o)&&(a[u]=0))}n.push(a)}return n}return null},query:function(e,t){var n=this.debug;this._db.transaction(function(i){n&&console.log("qeury: "+e),i.executeSql(e,[],function(e,n){_.isFunction(t)&&t(e,n)},function(e,n){_.isFunction(t)&&t(e,null,n)})})},_createTableSql:function(e){var t=this,n="CREATE TABLE "+e.name+" (",i=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];return _.forOwn(e.fields,function(n,r){t._cache[e.name+"_"+r]=n,"json"===n?n="text":"date"===n&&(n="real"),i.push(r+" "+n.toUpperCase())}),n+=i.join(", ")+")"},createTable:function(e,t,n){var i=this,r=this._createTableSql(e);return this.query(this._createTableSql(e),function(r,a,u){u&&5===u.code?i.query("SELECT * FROM "+e.name+" LIMIT 1",function(r,a,u){if(!a||0===a.rows.length&&n!==!0)i.dropTable(e.name,function(){i.createTable(e,t,!0)});else{var o=_.keys(a.rows.item(0)),s=_.keys(e.fields),c="ALTER TABLE "+e.name+" ADD COLUMN ",f=[],l="";s.map(function(t){-1===o.indexOf(t)&&(f.push(c+t+" "+e.fields[t]),l=l+t+";")});var d=0;f.forEach(function(e){i.query(e,function(e,n,i){d+=1,d===f.length&&_.isFunction(t)&&t(e,n,i,"add columns:"+l)})})}}):_.isFunction(t)&&t(r,a,u,n!==!0?"created":"drop created"),e.index.map(function(t){var n=_.keys(t),r=[],a=t.fields.join("")+" ON "+e.name+" ("+t.fields.join(", ")+")";n.map(function(e){"fields"!==e&&r.push(e)}),a="CREATE "+r.join(" ").toUpperCase()+" INDEX IF NOT EXISTS "+a,i.query(a)})}),r},_queryAll:function(e){return"SELECT * FROM "+e},all:function(e,t){var n=this,i=this._queryAll(e);return this.query(i,function(i,r){var a=n._fromWebSqlToJsValue(e,r);_.isFunction(t)&&t(a)}),i},_queryById:function(e,t){return"SELECT * FROM "+e+" WHERE id="+t},byId:function(e,t,n){var i=this._queryById(e,t),r=this;return this.query(i,function(t,i,a){var u=r._fromWebSqlToJsValue(e,i);u=u?u[0]:null,_.isFunction(n)&&n(u,a)}),i},_queryFind:function(e,t){var n="SELECT ";return n+=t.select?_.isString(t.select)?t.select:_.isArray(t.select)?t.select.join(", "):"*":"*",n+=" FROM "+e,t.where&&(n+=" WHERE",t.where.map(function(e){if(_.isObject(e)){var t=_.isString(e.value)?"'"+e.value+"'":e.value;n+=" "+e.field+e.op+t}else n+=" "+e})),t.order&&(n+=" ORDER BY "+t.order),t.limit&&(n+=" LIMIT "+t.limit),n},find:function(e,t,n){var i=this._queryFind(e,t),r=this;return this.query(i,function(i,a,u){var o=[];if(t.row!==!0)o=r._fromWebSqlToJsValue(e,a);else if(a&&0!==a.rows.length)for(var s=0;s<a.rows.length;s++)o.push(a.rows.item(s));_.isFunction(n)&&n(o,u)}),i},_queryInsert:function(e,t){var n=_.keys(t),i=[];n.map(function(e){t[e]&&i.push(e)}),i=["created_at","updated_at"].concat(i);var r=(new Date).getTime(),a=[r,r],u=this;return i.map(function(e){t[e]&&a.push(u._toWebSQLValue(t[e]))}),"INSERT INTO "+e+" ("+i.join(", ")+") VALUES ("+a.join(", ")+")"},insert:function(e,t,n){var i=this._queryInsert(e,t);return this.query(i,function(e,t,i){var r=t?t.insertId:null;_.isFunction(n)&&n(r,i)}),i},_queryUpdate:function(e,t){var n=this,i=["updated_at="+(new Date).getTime()],r="";for(var a in t)t.hasOwnProperty(a)&&("id"===a?r="id="+t[a]:i.push(a+"="+n._toWebSQLValue(t[a])));return"UPDATE "+e+" SET "+i.join(", ")+" WHERE "+r},update:function(e,t,n){if(t.id){var i=this._queryUpdate(e,t);return this.query(i,function(e,t,i){_.isFunction(n)&&n(i)}),i}},save:function(e,t,n){var i=t.id||null,r=this;return i?void this.byId(e,i,function(a,u){return a?r.update(e,t,function(e){_.isFunction(n)&&n(i,e,!1)}):r.insert(e,t,function(e,t){_.isFunction(n)&&n(e,t,!0)})}):r.insert(e,t,function(e,t){_.isFunction(n)&&n(e,t,!0)})},dropTable:function(e,t){var n="DROP TABLE "+e;this.query(n,function(e,n,i){t&&t(e,n,i)})},deleteById:function(e,t){var n="DELETE FROM "+e+" WHERE id="+t;this.query(n,function(e,t,n){})}};var n={_cache:{},openDatabase:function(e){return this._cache[e.name]||(this._cache[e.name]=new t(e)),this._cache[e.name]},_db:null,setDB:function(e){return this._db=this.openDatabase(e),this._db},getDB:function(){return this._db},fromObject:function(e,t,n){return null===n?t:(_(e.fields).forOwn(function(e,i){t[i]=n[i]}).value(),t.id=n.id,t.created_at=n.created_at,t.updated_at=n.updated_at,t)},toObject:function(e,t){var n={};return _(e.fields).forOwn(function(e,i){n[i]=t[i]}).value(),n.id=t.id,n},save:function(e,t,i){var r=this;this.createTableIfNotExist(e,function(){r.getDB().save(e.name,n.toObject(e,t),function(e){t.id=e,i()})})},byId:function(e,t,n,i){var r=this;r.createTableIfNotExist(t,function(){r.getDB().byId(t.name,e,function(e){i(r.fromObject(t,n,e))})})},byDateAndIdUser:function(e,t,n,i,r,a){var u=this;u.createTableIfNotExist(i,function(){var o={where:[{field:"id_user",op:"=",value:e},"and",{field:n,op:"=",value:t}]};u.getDB().find(i.name,o,function(e){a(null===e||0===e.length?r:u.fromObject(i,r,e[0]))})})},byPeriodAndIdUser:function(e,t,n,i,r,a,u){var o=this;o.createTableIfNotExist(r,function(){var s={where:[{field:"id_user",op:"=",value:e},"and",{field:i,op:">=",value:t},"and",{field:i,op:"<=",value:n}],order:i};o.getDB().find(r.name,s,function(e){if(null===e||0===e.length)u([]);else{var t=e.map(function(e){var t=new a;return o.fromObject(r,t,e)});u(t)}})})},isEmpty:function(e,t){var n=this;n.createTableIfNotExist(e,function(){n.getDB().query("SELECT count(id) AS ct FROM "+e.name,function(e,n,i){_.isFunction(callback)&&t(n&&0!==n.rows.length)})})},_createTableIfNotExistCache:{},createTableIfNotExist:function(e,t,n){return this._createTableIfNotExistCache[e.name]===!0&&n!==!0?void(void 0!==t&&t()):(this.getDB().createTable(e,t),void(this._createTableIfNotExistCache[e.name]=!0))}};return n});