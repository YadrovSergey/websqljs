!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():e.sqlitejs=n()}(this,function(){function e(e){return"string"==typeof e}function n(e){return"number"==typeof e}function t(e){return"function"==typeof e}function r(e){return"object"==typeof e}function i(e){var n;try{n=JSON.parse(e)}catch(t){n=e}return n}function a(e){var n;return n=new Date(e),70===n.getYear()&&0===n.getMonth()&&1===n.getDate()&&(n=e),n}var o=function(e){this._db=openDatabase(e.name,e.version,e.displayname,e.size)};o.prototype={query:function(e,n){this._db.transaction(function(r){r.executeSql(e,[],function(e,r){t(n)&&n(e,r)},function(e,r){t(n)&&n(e,null,r)})})},createTable:function(e){var n=this,t="CREATE TABLE "+e.name+" (",r=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];for(var i in e.fields)if(e.fields.hasOwnProperty(i)){var a=e.fields[i];"json"===a?a="text":"date"===a&&(a="real"),r.push(i+" "+a.toUpperCase())}t+=r.join(", ")+")",this.query(t,function(t,r){e.index.map(function(t){var r=Object.keys(t),i=[],a=t.fields.join("")+" ON "+e.name+" ("+t.fields.join(", ")+")";r.map(function(e){"fields"!==e&&i.push(e)}),a="CREATE "+i.join(" ").toUpperCase()+" INDEX "+a,n.query(a)})})},all:function(r,o){this.query("SELECT * FROM "+r,function(r,u){for(var f=[],c=0;c<u.rows.length;c++){var s=u.rows.item(c);for(var p in s)s.hasOwnProperty(p)&&(e(s[p])?s[p]=i(s[p]):n(s[p])&&(s[p]=a(s[p])));f.push(s)}t(o)&&o(f)})},byId:function(e,n,r){var i="SELECT * FROM "+e+" WHERE id="+n;this.query(i,function(e,n,i){var a=n?n.rows[0]:null;t(r)&&r(a,i)})},find:function(n,i,a){var o="SELECT * FROM "+n;i.where&&(o+=" WHERE",i.where.map(function(n){if(r(n)){var t=e(n.value)?"'"+n.value+"'":n.value;o+=" "+n.field+n.op+t}else o+=" "+n})),i.order&&(o+=" ORDER BY "+i.order),this.query(o,function(e,n,r){for(var i=[],o=0;o<n.rows.length;o++)i.push(n.rows[o]);t(a)&&a(i,r)})},insert:function(n,i,a){var o=(new Date).getTime(),u=["created_at","updated_at"].concat(Object.keys(i)),f=[o,o];u.map(function(n){var t=i[n];t&&(r(t)&&(t=t instanceof Date?t.getTime():JSON.stringify(t)),e(t)&&(t="'"+t+"'"),f.push(t))});var c="INSERT INTO "+n+" ("+u.join(", ")+") VALUES ("+f.join(", ")+")";this.query(c,function(e,n,r){var i=n?n.insertId:null;t(a)&&a(i,r)})}};var u={_cache:{},openDatabase:function(e){return this._cache[e.name]||(this._cache[e.name]=new o(e)),this._cache[e.name]}};return u});