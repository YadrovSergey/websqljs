!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():e.sqlitejs=n()}(this,function(){function e(e){return"string"==typeof e}function n(e){return"number"==typeof e}function t(e){return"function"==typeof e}function i(e){return"object"==typeof e}function r(e){var n;try{n=JSON.parse(e)}catch(t){n=e}return n}function a(e){var n;return n=new Date(e),70===n.getYear()&&0===n.getMonth()&&1===n.getDate()&&(n=e),n}var o=function(e){this._db=e.sqlitePlugin?sqlitePlugin.openDatabase(e.name,e.version,e.displayname,e.size):openDatabase(e.name,e.version,e.displayname,e.size),this.debug=e.debug||!1};o.prototype={_cellData:function(n){return n?(i(n)&&(n=n instanceof Date?n.getTime():JSON.stringify(n)),e(n)&&(n="'"+n+"'"),n):void 0},_convertRows:function(t){var i=[];if(t&&0!==t.rows.length){for(var o=0;o<t.rows.length;o++){var u=t.rows.item(o);for(var s in u)u.hasOwnProperty(s)&&(e(u[s])?u[s]=r(u[s]):n(u[s])&&(u[s]=a(u[s])));i.push(u)}return i}return null},query:function(e,n){var i=this.debug;this._db.transaction(function(r){i&&console.log("qeury: "+e),r.executeSql(e,[],function(e,i){t(n)&&n(e,i)},function(e,i){t(n)&&n(e,null,i)})})},createTable:function(e){var n=this,t="CREATE TABLE "+e.name+" (",i=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];for(var r in e.fields)if(e.fields.hasOwnProperty(r)){var a=e.fields[r];"json"===a?a="text":"date"===a&&(a="real"),i.push(r+" "+a.toUpperCase())}return t+=i.join(", ")+")",this.query(t,function(t,i,r){r&&5===r.code&&n.query("SELECT * FROM "+e.name+" LIMIT 1",function(t,i,r){if(i&&0!==i.rows.length){var a=Object.keys(i.rows[0]),o=Object.keys(e.fields),u="ALTER TABLE "+e.name+" ADD COLUMN ";o.map(function(t){-1===a.indexOf(t)&&n.query(u+t+" "+e.fields[t])})}}),e.index.map(function(t){var i=Object.keys(t),r=[],a=t.fields.join("")+" ON "+e.name+" ("+t.fields.join(", ")+")";i.map(function(e){"fields"!==e&&r.push(e)}),a="CREATE "+r.join(" ").toUpperCase()+" INDEX "+a,n.query(a)})}),t},all:function(e,n){var i=this,r="SELECT * FROM "+e;return this.query(r,function(e,r){var a=i._convertRows(r);t(n)&&n(a)}),r},byId:function(e,n,i){var r="SELECT * FROM "+e+" WHERE id="+n,a=this;return this.query(r,function(e,n,r){var o=a._convertRows(n);o=o?o[0]:null,t(i)&&i(o,r)}),r},find:function(n,r,a){var o="SELECT * FROM "+n,u=this;return r.where&&(o+=" WHERE",r.where.map(function(n){if(i(n)){var t=e(n.value)?"'"+n.value+"'":n.value;o+=" "+n.field+n.op+t}else o+=" "+n})),r.order&&(o+=" ORDER BY "+r.order),this.query(o,function(e,n,i){var r=u._convertRows(n);t(a)&&a(r,i)}),o},insert:function(e,n,i){var r=Object.keys(n),a=[];r.map(function(e){n[e]&&a.push(e)}),a=["created_at","updated_at"].concat(a);var o=(new Date).getTime(),u=[o,o],s=this;a.map(function(e){n[e]&&u.push(s._cellData(n[e]))});var c="INSERT INTO "+e+" ("+a.join(", ")+") VALUES ("+u.join(", ")+")";return this.query(c,function(e,n,r){var a=n?n.insertId:null;t(i)&&i(a,r)}),c},update:function(e,n,i){if(n.id){var r=this,a=["updated_at="+(new Date).getTime()],o="";for(var u in n)n.hasOwnProperty(u)&&("id"===u?o="id="+n[u]:a.push(u+"="+r._cellData(n[u])));var s="UPDATE "+e+" SET "+a.join(", ")+" WHERE "+o;return this.query(s,function(e,n,r){t(i)&&i(r)}),s}},save:function(e,n,i){var r=n.id||null,a=this;return r?void this.byId(e,r,function(o,u){return o?a.update(e,n,function(e){t(i)&&(e?i(null,e):i(r))}):a.insert(e,n,function(e,n){t(i)&&i(e,n)})}):a.insert(e,n,function(e,n){t(i)&&i(e,n)})},dropTable:function(e){var n="DROP TABLE "+e;this.query(n,function(e,n,t){})},deleteById:function(e,n){var t="DELETE FROM "+e+" WHERE id="+n;this.query(t,function(e,n,t){})}};var u={_cache:{},openDatabase:function(e){return this._cache[e.name]||(this._cache[e.name]=new o(e)),this._cache[e.name]}};return u});