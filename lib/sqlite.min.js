!function(n,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():n.sqlitejs=e()}(this,function(){function n(n){return"string"==typeof n}function e(n){return"number"==typeof n}function t(n){return"function"==typeof n}function i(n){return"object"==typeof n}function r(n){var e;try{e=JSON.parse(n)}catch(t){e=n}return e}function a(n){var e;return e=new Date(n),70===e.getYear()&&0===e.getMonth()&&1===e.getDate()&&(e=n),e}var o=function(n){this._db=openDatabase(n.name,n.version,n.displayname,n.size)};o.prototype={_cellData:function(e){return e?(i(e)&&(e=e instanceof Date?e.getTime():JSON.stringify(e)),n(e)&&(e="'"+e+"'"),e):void 0},query:function(n,e){this._db.transaction(function(i){i.executeSql(n,[],function(n,i){t(e)&&e(n,i)},function(n,i){t(e)&&e(n,null,i)})})},createTable:function(n){var e=this,t="CREATE TABLE "+n.name+" (",i=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];for(var r in n.fields)if(n.fields.hasOwnProperty(r)){var a=n.fields[r];"json"===a?a="text":"date"===a&&(a="real"),i.push(r+" "+a.toUpperCase())}t+=i.join(", ")+")",this.query(t,function(t,i){n.index.map(function(t){var i=Object.keys(t),r=[],a=t.fields.join("")+" ON "+n.name+" ("+t.fields.join(", ")+")";i.map(function(n){"fields"!==n&&r.push(n)}),a="CREATE "+r.join(" ").toUpperCase()+" INDEX "+a,e.query(a)})})},all:function(i,o){this.query("SELECT * FROM "+i,function(i,u){for(var f=[],c=0;c<u.rows.length;c++){var s=u.rows.item(c);for(var d in s)s.hasOwnProperty(d)&&(n(s[d])?s[d]=r(s[d]):e(s[d])&&(s[d]=a(s[d])));f.push(s)}t(o)&&o(f)})},byId:function(n,e,i){var r="SELECT * FROM "+n+" WHERE id="+e;this.query(r,function(n,e,r){var a;a=0===e.rows.length?null:e.rows[0],t(i)&&i(a,r)})},find:function(e,r,a){var o="SELECT * FROM "+e;r.where&&(o+=" WHERE",r.where.map(function(e){if(i(e)){var t=n(e.value)?"'"+e.value+"'":e.value;o+=" "+e.field+e.op+t}else o+=" "+e})),r.order&&(o+=" ORDER BY "+r.order),this.query(o,function(n,e,i){for(var r=[],o=0;o<e.rows.length;o++)r.push(e.rows[o]);t(a)&&a(r,i)})},insert:function(n,e,i){var r=Object.keys(e),a=[];r.map(function(n){e[n]&&a.push(n)}),a=["created_at","updated_at"].concat(a);var o=(new Date).getTime(),u=[o,o],f=this;a.map(function(n){e[n]&&u.push(f._cellData(e[n]))});var c="INSERT INTO "+n+" ("+a.join(", ")+") VALUES ("+u.join(", ")+")";this.query(c,function(n,e,r){var a=e?e.insertId:null;t(i)&&i(a,r)})},update:function(n,e,i){if(e.id){var r=this,a=["updated_at="+(new Date).getTime()],o="";for(var u in e)e.hasOwnProperty(u)&&("id"===u?o="id="+e[u]:a.push(u+"="+r._cellData(e[u])));var f="UPDATE "+n+" SET "+a.join(", ")+" WHERE "+o;this.query(f,function(n,e,r){t(i)&&i(r)})}},save:function(n,e,i){var r=e.id||null,a=this;r?this.byId(n,r,function(o,u){o?a.update(n,e,function(n){t(i)&&(n?i(null,n):i(r))}):a.insert(n,e,function(n,e){t(i)&&i(n,e)})}):a.insert(n,e,function(n,e){t(i)&&i(n,e)})}};var u={_cache:{},openDatabase:function(n){return this._cache[n.name]||(this._cache[n.name]=new o(n)),this._cache[n.name]}};return u});