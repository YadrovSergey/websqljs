!function(e,n){"function"==typeof define&&define.amd?define(["lodash"],n):"object"==typeof exports?module.exports=n(require("lodash")):e.sqlitejs=n(e.lodash)}(this,function(e){var n=function(e){e.sqlitePlugin?this._db=window.sqlitePlugin.openDatabase(e.name,e.version,e.displayname,e.size):this._db=openDatabase(e.name,e.version,e.displayname,e.size),this.debug=e.debug||!1};n.prototype={_cache:{},_toWebSQLValue:function(e){return(_.isObject(e)||_.isArray(e))&&(e=e instanceof Date?e.getTime():JSON.stringify(e)),_.isString(e)&&(e="'"+e+"'"),e},_fromWebSqlToJsValue:function(e,n){var t=[];if(n&&n.rows&&0!==n.rows.length){for(var i=0;i<n.rows.length;i++){var r=n.rows.item(i),u={};for(var a in r)if(r.hasOwnProperty(a)){u[a]=r[a];var o=this._cache[e+"_"+a];"json"===o?u[a]=JSON.parse(r[a]):"date"===o||"created_at"===a||"updated_at"===a?u[a]=new Date(r[a]):(null===u[a]||void 0===u[a])&&("text"===o?u[a]="":("numeric"===o||"integer"===o)&&(u[a]=0))}t.push(u)}return t}return null},query:function(e,n){var t=this.debug;this._db.transaction(function(i){t&&console.log("qeury: "+e),i.executeSql(e,[],function(e,t){_.isFunction(n)&&n(e,t)},function(e,t){_.isFunction(n)&&n(e,null,t)})})},_createTableSql:function(e){var n=this,t="CREATE TABLE "+e.name+" (",i=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];return _.forOwn(e.fields,function(t,r){n._cache[e.name+"_"+r]=t,"json"===t?t="text":"date"===t&&(t="real"),i.push(r+" "+t.toUpperCase())}),t+=i.join(", ")+")"},createTable:function(e,n,t){var i=this,r=this._createTableSql(e);return this.query(this._createTableSql(e),function(r,u,a){a&&5===a.code?i.query("SELECT * FROM "+e.name+" LIMIT 1",function(r,u,a){if(!u||0===u.rows.length&&t!==!0)i.dropTable(e.name,function(){i.createTable(e,n,!0)});else{var o=Object.keys(u.rows.item(0)),s=Object.keys(e.fields),c="ALTER TABLE "+e.name+" ADD COLUMN ",f=[],l="";s.map(function(n){-1===o.indexOf(n)&&(f.push(c+n+" "+e.fields[n]),l=l+n+";")});var d=0;f.forEach(function(e){i.query(e,function(e,t,i){d+=1,d===f.length&&_.isFunction(n)&&n(e,t,i,"add columns:"+l)})})}}):_.isFunction(n)&&n(r,u,a,t!==!0?"created":"drop created"),e.index.map(function(n){var t=Object.keys(n),r=[],u=n.fields.join("")+" ON "+e.name+" ("+n.fields.join(", ")+")";t.map(function(e){"fields"!==e&&r.push(e)}),u="CREATE "+r.join(" ").toUpperCase()+" INDEX IF NOT EXISTS "+u,i.query(u)})}),r},_queryAll:function(e){return"SELECT * FROM "+e},all:function(e,n){var t=this,i=this._queryAll(e);return this.query(i,function(i,r){var u=t._fromWebSqlToJsValue(e,r);_.isFunction(n)&&n(u)}),i},_queryById:function(e,n){return"SELECT * FROM "+e+" WHERE id="+n},byId:function(e,n,t){var i=this._queryById(e,n),r=this;return this.query(i,function(n,i,u){var a=r._fromWebSqlToJsValue(e,i);a=a?a[0]:null,_.isFunction(t)&&t(a,u)}),i},_queryFind:function(e,n){var t="SELECT ";return t+=n.select?_.isString(n.select)?n.select:_.isArray(n.select)?n.select.join(", "):"*":"*",t+=" FROM "+e,n.where&&(t+=" WHERE",n.where.map(function(e){if(_.isObject(e)){var n=_.isString(e.value)?"'"+e.value+"'":e.value;t+=" "+e.field+e.op+n}else t+=" "+e})),n.order&&(t+=" ORDER BY "+n.order),n.limit&&(t+=" LIMIT "+n.limit),t},find:function(e,n,t){var i=this._queryFind(e,n),r=this;return this.query(i,function(i,u,a){var o=[];if(n.row!==!0)o=r._fromWebSqlToJsValue(e,u);else if(u&&0!==u.rows.length)for(var s=0;s<u.rows.length;s++)o.push(u.rows.item(s));_.isFunction(t)&&t(o,a)}),i},_queryInsert:function(e,n){var t=Object.keys(n),i=[];t.map(function(e){n[e]&&i.push(e)}),i=["created_at","updated_at"].concat(i);var r=(new Date).getTime(),u=[r,r],a=this;return i.map(function(e){n[e]&&u.push(a._toWebSQLValue(n[e]))}),"INSERT INTO "+e+" ("+i.join(", ")+") VALUES ("+u.join(", ")+")"},insert:function(e,n,t){var i=this._queryInsert(e,n);return this.query(i,function(e,n,i){var r=n?n.insertId:null;_.isFunction(t)&&t(r,i)}),i},_queryUpdate:function(e,n){var t=this,i=["updated_at="+(new Date).getTime()],r="";for(var u in n)n.hasOwnProperty(u)&&("id"===u?r="id="+n[u]:i.push(u+"="+t._toWebSQLValue(n[u])));return"UPDATE "+e+" SET "+i.join(", ")+" WHERE "+r},update:function(e,n,t){if(n.id){var i=this._queryUpdate(e,n);return this.query(i,function(e,n,i){_.isFunction(t)&&t(i)}),i}},save:function(e,n,t){var i=n.id||null,r=this;return i?void this.byId(e,i,function(u,a){return u?r.update(e,n,function(e){_.isFunction(t)&&t(i,e,!1)}):r.insert(e,n,function(e,n){_.isFunction(t)&&t(e,n,!0)})}):r.insert(e,n,function(e,n){_.isFunction(t)&&t(e,n,!0)})},dropTable:function(e,n){var t="DROP TABLE "+e;this.query(t,function(e,t,i){n&&n(e,t,i)})},deleteById:function(e,n){var t="DELETE FROM "+e+" WHERE id="+n;this.query(t,function(e,n,t){})}};var t={_cache:{},openDatabase:function(e){return this._cache[e.name]||(this._cache[e.name]=new n(e)),this._cache[e.name]}};return t});