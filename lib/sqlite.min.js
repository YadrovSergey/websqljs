!function(n,e){"function"==typeof define&&define.amd?define(["lodash"],e):"object"==typeof exports?module.exports=e(require("lodash")):n.sqlitejs=e(n.lodash)}(this,function(n){var e=function(n){this._db=n.sqlitePlugin?window.sqlitePlugin.openDatabase(n.name,n.version,n.displayname,n.size):openDatabase(n.name,n.version,n.displayname,n.size),this.debug=n.debug||!1};e.prototype={_cache:{},_cellData:function(n){return n?(_.isObject(n)&&(n=n instanceof Date?n.getTime():JSON.stringify(n)),_.isString(n)&&(n="'"+n+"'"),n):void 0},_convertRows:function(n,e){var t=[];if(e&&0!==e.rows.length){for(var i=0;i<e.rows.length;i++){var r=e.rows.item(i);for(var o in r)r.hasOwnProperty(o)&&("json"===this._cache[n+"_"+o]?r[o]=JSON.parse(r[o]):"date"===this._cache[n+"_"+o]&&(r[o]=new Date(r[o])));t.push(r)}return t}return null},query:function(n,e){var t=this.debug;this._db.transaction(function(i){t&&console.log("qeury: "+n),i.executeSql(n,[],function(n,t){_.isFunction(e)&&e(n,t)},function(n,t){_.isFunction(e)&&e(n,null,t)})})},createTable:function(n,e){var t=this,i="CREATE TABLE "+n.name+" (",r=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];for(var o in n.fields)if(n.fields.hasOwnProperty(o)){var a=n.fields[o];this._cache[n.name+"_"+o]=a,"json"===a?a="text":"date"===a&&(a="real"),r.push(o+" "+a.toUpperCase())}return i+=r.join(", ")+")",this.query(i,function(i,r,o){o&&5===o.code&&t.query("SELECT * FROM "+n.name+" LIMIT 1",function(e,i,r){if(i&&0!==i.rows.length){var o=Object.keys(i.rows[0]),a=Object.keys(n.fields),s="ALTER TABLE "+n.name+" ADD COLUMN ";a.map(function(e){-1===o.indexOf(e)&&t.query(s+e+" "+n.fields[e])})}}),_.isFunction(e)&&e(i,r,o),n.index.map(function(e){var i=Object.keys(e),r=[],o=e.fields.join("")+" ON "+n.name+" ("+e.fields.join(", ")+")";i.map(function(n){"fields"!==n&&r.push(n)}),o="CREATE "+r.join(" ").toUpperCase()+" INDEX IF NOT EXISTS "+o,t.query(o)})}),i},all:function(n,e){var t=this,i="SELECT * FROM "+n;return this.query(i,function(i,r){var o=t._convertRows(n,r);_.isFunction(e)&&e(o)}),i},byId:function(n,e,t){var i="SELECT * FROM "+n+" WHERE id="+e,r=this;return this.query(i,function(e,i,o){var a=r._convertRows(n,i);a=a?a[0]:null,_.isFunction(t)&&t(a,o)}),i},find:function(n,e,t){var i="SELECT ",r=this;return i+=e.select?e.select.join(", "):"*",i+=" FROM "+n,e.where&&(i+=" WHERE",e.where.map(function(n){if(_.isObject(n)){var e=_.isString(n.value)?"'"+n.value+"'":n.value;i+=" "+n.field+n.op+e}else i+=" "+n})),e.order&&(i+=" ORDER BY "+e.order),e.limit&&(i+=" LIMIT "+e.limit),this.query(i,function(i,o,a){var s=[];if(e.row!==!0)s=r._convertRows(n,o);else if(o&&0!==o.rows.length)for(var u=0;u<o.rows.length;u++)s.push(o.rows.item(u));_.isFunction(t)&&t(s,a)}),i},insert:function(n,e,t){var i=Object.keys(e),r=[];i.map(function(n){e[n]&&r.push(n)}),r=["created_at","updated_at"].concat(r);var o=(new Date).getTime(),a=[o,o],s=this;r.map(function(n){e[n]&&a.push(s._cellData(e[n]))});var u="INSERT INTO "+n+" ("+r.join(", ")+") VALUES ("+a.join(", ")+")";return this.query(u,function(n,e,i){var r=e?e.insertId:null;_.isFunction(t)&&t(r,i)}),u},update:function(n,e,t){if(e.id){var i=this,r=["updated_at="+(new Date).getTime()],o="";for(var a in e)e.hasOwnProperty(a)&&("id"===a?o="id="+e[a]:r.push(a+"="+i._cellData(e[a])));var s="UPDATE "+n+" SET "+r.join(", ")+" WHERE "+o;return this.query(s,function(n,e,i){_.isFunction(t)&&t(i)}),s}},save:function(n,e,t){var i=e.id||null,r=this;return i?void this.byId(n,i,function(o,a){return o?r.update(n,e,function(n){_.isFunction(t)&&t(i,n,!1)}):r.insert(n,e,function(n,e){_.isFunction(t)&&t(n,e,!0)})}):r.insert(n,e,function(n,e){_.isFunction(t)&&t(n,e,!0)})},dropTable:function(n){var e="DROP TABLE "+n;this.query(e,function(n,e,t){})},deleteById:function(n,e){var t="DELETE FROM "+n+" WHERE id="+e;this.query(t,function(n,e,t){})}};var t={_cache:{},openDatabase:function(n){return this._cache[n.name]||(this._cache[n.name]=new e(n)),this._cache[n.name]}};return t});