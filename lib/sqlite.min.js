!function(n,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():n.sqlitejs=t()}(this,function(){function n(n){return"string"==typeof n}function t(n){return"number"==typeof n}function e(n){return"function"==typeof n}function i(n){return"object"==typeof n}function r(n){var t;try{t=JSON.parse(n)}catch(e){t=n}return t}function a(n){var t;return t=new Date(n),70===t.getYear()&&0===t.getMonth()&&1===t.getDate()&&(t=n),t}var o=function(n){this._db=openDatabase(n.name,n.version,n.displayname,n.size),this.debug=n.debug||!1};o.prototype={_cellData:function(t){return t?(i(t)&&(t=t instanceof Date?t.getTime():JSON.stringify(t)),n(t)&&(t="'"+t+"'"),t):void 0},_convertRows:function(e){var i=[];if(e&&0!==e.rows.length){for(var o=0;o<e.rows.length;o++){var u=e.rows.item(o);for(var c in u)u.hasOwnProperty(c)&&(n(u[c])?u[c]=r(u[c]):t(u[c])&&(u[c]=a(u[c])));i.push(u)}return i}return null},query:function(n,t){var i=this.debug;this._db.transaction(function(r){i&&console.log("qeury: "+n),r.executeSql(n,[],function(n,i){e(t)&&t(n,i)},function(n,i){e(t)&&t(n,null,i)})})},createTable:function(n){var t=this,e="CREATE TABLE "+n.name+" (",i=["id INTEGER PRIMARY KEY AUTOINCREMENT","created_at REAL","updated_at REAL"];for(var r in n.fields)if(n.fields.hasOwnProperty(r)){var a=n.fields[r];"json"===a?a="text":"date"===a&&(a="real"),i.push(r+" "+a.toUpperCase())}e+=i.join(", ")+")",this.query(e,function(e,i){n.index.map(function(e){var i=Object.keys(e),r=[],a=e.fields.join("")+" ON "+n.name+" ("+e.fields.join(", ")+")";i.map(function(n){"fields"!==n&&r.push(n)}),a="CREATE "+r.join(" ").toUpperCase()+" INDEX "+a,t.query(a)})})},all:function(n,t){var i=this;this.query("SELECT * FROM "+n,function(n,r){var a=i._convertRows(r);e(t)&&t(a)})},byId:function(n,t,i){var r="SELECT * FROM "+n+" WHERE id="+t,a=this;this.query(r,function(n,t,r){var o=a._convertRows(t);e(i)&&i(o[0],r)})},find:function(t,r,a){var o="SELECT * FROM "+t,u=this;r.where&&(o+=" WHERE",r.where.map(function(t){if(i(t)){var e=n(t.value)?"'"+t.value+"'":t.value;o+=" "+t.field+t.op+e}else o+=" "+t})),r.order&&(o+=" ORDER BY "+r.order),this.query(o,function(n,t,i){var r=u._convertRows(t);e(a)&&a(r,i)})},insert:function(n,t,i){var r=Object.keys(t),a=[];r.map(function(n){t[n]&&a.push(n)}),a=["created_at","updated_at"].concat(a);var o=(new Date).getTime(),u=[o,o],c=this;a.map(function(n){t[n]&&u.push(c._cellData(t[n]))});var s="INSERT INTO "+n+" ("+a.join(", ")+") VALUES ("+u.join(", ")+")";this.query(s,function(n,t,r){var a=t?t.insertId:null;e(i)&&i(a,r)})},update:function(n,t,i){if(t.id){var r=this,a=["updated_at="+(new Date).getTime()],o="";for(var u in t)t.hasOwnProperty(u)&&("id"===u?o="id="+t[u]:a.push(u+"="+r._cellData(t[u])));var c="UPDATE "+n+" SET "+a.join(", ")+" WHERE "+o;this.query(c,function(n,t,r){e(i)&&i(r)})}},save:function(n,t,i){var r=t.id||null,a=this;r?this.byId(n,r,function(o,u){o?a.update(n,t,function(n){e(i)&&(n?i(null,n):i(r))}):a.insert(n,t,function(n,t){e(i)&&i(n,t)})}):a.insert(n,t,function(n,t){e(i)&&i(n,t)})}};var u={_cache:{},openDatabase:function(n){return this._cache[n.name]||(this._cache[n.name]=new o(n)),this._cache[n.name]}};return u});